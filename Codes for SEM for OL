#Creating an SEM to describe the relationship between manifest variables and latent umbrella constructs
#Using the Lavaan package

Tofu<-read.csv("Tofu.csv")
New<-as.factor(New)
Temp<-as.factor(Temp)
SE<-as.factor(SE)
NE<-as.factor(NE)
Canada<-as.factor(Canada)
Food_service<-as.factor(Food_service)
Retail<-as.factor(Retail)
Club<-as.factor(Club)
Private_label<-as.factor(Private_label)
Friday_ship<-as.factor(Friday_ship)
Major_holiday<-as.factor(Major_holiday)
Other_holiday<-as.factor(Other_holiday)
Waterpack<-as.factor(Waterpack)

library(lavaan)
Tofu$Week <- Tofu$Week/100 
#Each model should contain at least 3 variables so that the latent variable can be estimated
#because the degrees of freedom are based on the variables, not on sample size.
#Do not construct a model that has 0 degrees of freedom

#Define the model:
# example: model<-'latent_variable =~manifest_variable1 + manifest_variable2 + manifest_variable3'

tofu.model<-'Sales_group =~Private_label + Club + Retail + Food_service
            Seasonal =~Major_holiday + Other_holiday + Week + Season'
            
            Shipping =~Friday_ship + Other_site
            Customer_preference =~ Texture + Size
            Selling_area =~ Canada + a*SE + a*NE
            Product_establishment =~ Temp + New'

#The model can either be scaled by setting the variance of the latent variable to 1, and dividing this between the manifest variables
#OR we can set the variance of one of the manifest variables to 1 (more commonly used approach). This is the Lavaan default.

#Now fit the model (run a factor analysis to check how well the manifest variables explain the latent variable):
tofu.fit<-cfa(model=tofu.model, data=Tofu)
summary(tofu.fit, standardized=TRUE, fit.measures=TRUE)

#Interpreting: Different manifest variables have different loadings on the latent variables.
#Std.all in the output shows these loadings. Close to 1 shows a strong relationship to the latent variable.
#0.3 is typically considered an acceptable loading.
#CFI and TLI should be between 0.9 and 1 to show that the model fits the data

