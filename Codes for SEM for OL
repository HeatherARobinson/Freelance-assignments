#Creating an SEM to describe the relationship between manifest variables and latent umbrella constructs
#Using the Lavaan package

Tofu<-read.csv("Tofu.csv")
New<-as.factor(New)
Flavor<-as.factor(Flavor)
Temporary<-as.factor(Temporary)
SE<-as.factor(SE)
NE<-as.factor(NE)
Canada<-as.factor(Canada)
Food_service<-as.factor(Food_service)
Retail<-as.factor(Retail)
Club<-as.factor(Club)
Private_label<-as.factor(Private_label)
Friday_ship<-as.factor(Friday_ship)
Other_Site<-as.factor(Other_Site)
major_holiday<-as.factor(major_holiday)
other_holiday<-as.factor(other_holidays)
Waterpack<-as.factor(Waterpack)

#To combine the 2 tofu datasets we have made some assumptions
#This is because Lavaan deletes an entire row if there is any missing data
#For texture, this is not given for flavored tofu so we have assumed a median texture (4)
#There is no idencation of pack type for flavored tofu so I have assumed it is waterpacked
#We assume none of the flavored tofu is produced offsite
#Flavor now has 13 levels, 13 being plain


library(lavaan)
Tofu$Week <- Tofu$Week/100 
Tofu$Texture <- Tofu$Texture/10 
Tofu$Temporary<- Tofu$Temporary*10
Tofu$season <- Tofu$season/10 
#Each model should contain at least 3 variables so that the latent variable can be estimated
#because the degrees of freedom are based on the variables, not on sample size.
#Do not construct a model that has 0 degrees of freedom

#Define the model:
# example: model<-'latent_variable =~manifest_variable1 + manifest_variable2 + manifest_variable3'

tofu.model<-'Sales_group =~Private_Label + a*Club + a*Retail + a*Food_service
            Seasonal =~major_holiday + other_holidays + week + season'
            
            Shipping =~Friday_Shipping + Other_Site
            Customer_preference =~ Texture + Size + Promotion
            Selling_area =~ Canada + a*SE + a*NE
            Product_establishment =~ Temp + New'

#The model can either be scaled by setting the variance of the latent variable to 1, and dividing this between the manifest variables
#OR we can set the variance of one of the manifest variables to 1 (more commonly used approach). This is the Lavaan default.

#Now fit the model (run a factor analysis to check how well the manifest variables explain the latent variable):
tofu.fit<-cfa(model=tofu.model, data=Tofu)
summary(tofu.fit, standardized=TRUE, fit.measures=TRUE)

#Interpreting: Different manifest variables have different loadings on the latent variables.
#Std.all in the output shows these loadings. Close to 1 shows a strong relationship to the latent variable.
#0.3 is typically considered an acceptable loading.
#CFI and TLI should be between 0.9 and 1 to show that the model fits the data

