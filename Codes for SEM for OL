#Creating an SEM to describe the relationship between manifest variables and latent umbrella constructs
#Using the Lavaan package

Tofu<-read.csv("Tofu2.csv")
attach(Tofu)

#To combine the 2 tofu datasets we have made some assumptions
#This is because Lavaan deletes an entire row if there is any missing data
#Texture and size are not given for flavored tofu so we have assumed a median texture (4) and size (2)
#There is no idencation of pack type for flavored tofu so I have assumed it is waterpacked
#We assume none of the flavored tofu is produced offsite
#Flavor now has 13 levels, 13 being plain


library(lavaan)

#The variances across the variables need to be similar. We can scale them if they are not:
Tofu$season <- Tofu$season/10
#Tofu$Texture <- Tofu$Texture/10
#Tofu$Flavor <- Tofu$Flavor/10
Tofu$week <- Tofu$week/100


#Each latent construct should contain at least 3 variables so that the latent variable can be estimated
#because the degrees of freedom are based on the variables, not on sample size.
#Do not construct a model that has 0 degrees of freedom

#Define the model:
# example: model<-'latent_variable =~manifest_variable1 + manifest_variable2 + manifest_variable3'

#So far seasonal looks good. All but week are over 0.9 for Std.all- standardised . Week is less relevant in predicting season.

tofu.model<-'Seasonal =~major_holiday + other_holidays + week + season
week~~season
major_holiday ~~ other_holidays'

Selling_area =~ Canada + SE + NE
Seasonal ~~ 0*Selling_area
Product_establishment =~ Temporary + a*New
Seasonal ~~ 0*Product_establishment
Customer_preference =~ Texture + a*Size + a*Promotion
NE ~~ New
SE ~~ New
NE ~~ Temporary
SE ~~ Temporary
Customer_preference =~ Canada
Customer_preference =~ SE'

anova(tofu.model1,tofu.model2)- confirm any additions with ANOVA.

#In the model code, #~ shows that a manifest variable is predicting a latent variable. ~~ shows a correlation between variables.

tofu.fit<-cfa(model=tofu.model, data=Tofu)
summary(tofu.fit, standardized=TRUE, fit.measures=TRUE)

#POSSIBLE ERRORS- "not positive definite"- the wrong classes have been specified. 2 may need to be merged. 1 variable may be a combination of others.
#



modificationindices(tofu.fit, sort = TRUE)
#also include Waterpack

#Shipping =~Friday_Shipping + a*Other_Site
           
#Sales_group =~Private_Label + a*Club + a*Retail


#The model can either be scaled by setting the variance of the latent variable to 1, and dividing this between the manifest variables
#OR we can set the variance of one of the manifest variables to 1 (more commonly used approach). This is the Lavaan default.

#Now fit the model (run a factor analysis to check how well the manifest variables explain the latent variable):

#Interpreting: Different manifest variables have different loadings on the latent variables.
#Std.all in the output shows these loadings. Close to 1 shows a strong relationship to the latent variable.
#0.3 is typically considered an acceptable loading.
#CFI and TLI should be between 0.9 and 1 to show that the model fits the data

