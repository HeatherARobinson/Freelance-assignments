#Creating an SEM to describe the relationship between manifest variables and latent umbrella constructs
#Using the Lavaan package

Tofu<-read.csv("Tofu2.csv")
attach(Tofu)

#To combine the 2 tofu datasets we have made some assumptions
#This is because Lavaan deletes an entire row if there is any missing data
#Texture and size are not given for flavored tofu so we have assumed a median texture (4) and size (2)
#There is no idencation of pack type for flavored tofu so I have omitted waterpack as a variable
#We assume none of the flavored tofu is produced offsite
#Flavor now has 13 levels, 13 being plain


library(lavaan)

#The variances across the variables need to be similar. We can scale them if they are not:
Tofu$season <- Tofu$season/10
Tofu$Texture <- Tofu$Texture/10
Tofu$Flavor <- as.character(Tofu$Flavor)
Tofu$week <- Tofu$week/100
Tofu$Size<-Tofu$Size/10
Tofu$sales<-as.numeric(Tofu$sales)

#Each latent construct should contain at least 3 variables so that the latent variable can be estimated
#because the degrees of freedom are based on the variables, not on sample size.
#Do not construct a model that has 0 degrees of freedom

#Define the model:
# example: model<-'latent_variable =~manifest_variable1 + manifest_variable2 + manifest_variable3'

#So far seasonal looks good. All but week are over 0.9 for Std.all- standardised . Week is less relevant in predicting season.

tofu.model.a<-
'Seasonal =~major_holiday + other_holidays + week + season

Sales_area =~ Canada + SE + NE

Customer_preference =~ Texture + Size + Promotion + Flavor + Waterpack

Product_establishment =~ Temporary + New

Sales_Group =~ Private_Label + Club + Retail'

tofu.fit.a<-cfa(model=tofu.model.a, data=Tofu)

#This first model won't converge because at least 2 latent variables overlap and need combining (matrix is not positive-definite)
#There are two few degrees of freedom to have latent constucts consisting of fewer than 3 variables-
#Combine size with Sales group in a variable called Presentation- because large sizes were only for retail and this corrected an overlap
#of what was being measured in Customer preference and Sales group.
#Shipping variables are now grouped with Sales area due to the correlations between Friday shipping and other site manufacture and distribution area
#Based on a 1 factor model of season I have dropped week as there is too much overlap with the other variables


tofu.model.b<-'Seasonal =~major_holiday + other_holidays + season

Customer_preference =~ Texture + Flavor + Promotion + Temporary + New

Presentation =~Private_Label + Club + Retail + Size

Distribution =~Canada + SE + NE + Friday_Shipping + Other_Site'

tofu.fit.b<-cfa(model=tofu.model.b, data=Tofu)

summary(tofu.fit.b, standardized=TRUE, fit.measures=TRUE)

#A solution has still "not been found" 


tofu.model.c<-'Seasonal =~major_holiday + a*other_holidays + a*season

Customer_preference=~Texture + a*Flavor + a*Size

Product_establishment=~New +a*Promotion + a*Temporary

Distribution =~Canada + a*SE + a*NE + a*Friday_Shipping +a*Other_Site'

tofu.fit.c<-cfa(model=tofu.model.c, data=Tofu)
summary(tofu.fit.c, standardized=TRUE, fit.measures=TRUE)

#The model will converge without having sales group and size in the same model
#But not with both as size closely reflects retail, club and private label.
#Try including retail with size etc
#Combine sales group with customer preference to allow sufficient dfs

tofu.model.d<-'Seasonal =~major_holiday + other_holidays + season
Customer_preference=~Texture + a*Flavor + a*Size + a*Retail + a*Private_Label + a*Club
Product_establishment=~New +a*Promotion + a*Temporary
Distribution =~Canada + SE + NE + Friday_Shipping +Other_Site'
 
tofu.fit.d<-cfa(model=tofu.model.d, data=Tofu
#This causes issues with matrix not being positive-definitive: Retail, private and/or club are resampling some other variable.

tofu.model.e<-'Seasonal =~major_holiday + a*other_holidays + a*season
Customer_preference=~Texture + a*Flavor  + a*Size
Product_establishment=~New +a*Promotion + a*Temporary
Area =~Canada + a*SE + a*NE
Distribution=~a*Friday_Shipping +a*Other_Site+ a*Retail+a*Private_Label'
tofu.fit.e<-cfa(model=tofu.model.e, data=Tofu)

#Still not converging- try dropping Club, which is not very informative
#Distribution is better fitted if separated out again
#I have confirmed the following fit well as one factor models before combining but there are still issues:
#friday shipping is removed as it only applies to SE

tofu.model.f<-'Seasonal =~major_holiday + other_holidays + season
Customer_preference=~Texture+Flavor
Product_presentation=~Size +Retail+Promotion + Temporary + New
Distribution =~Canada + a*SE + a*NE
Texture~~0.0207125*Texture'

tofu.fit.f<-cfa(model=tofu.model.f, data=Tofu)

modificationindices(tofu.fit.f, sort = TRUE)



#Compare the two fitted values
fitmeasures(tofu.fit.c,c("aic","ecvi"))
fitmeasures(tofu.fit.d,c("aic","ecvi"))
#c has a lower AIC so retail should not go in customer preference in this way.

#Try adding sales group constructs to distribution

tofu.model.e<-'Seasonal =~major_holiday + other_holidays + season
Customer_preference=~Texture + a*Flavor + a*Size
Product_establishment=~New +a*Promotion + a*Temporary
Distribution =~Canada + SE + NE + Friday_Shipping +Other_Site + Retail+Club+Private_Label'

tofu.fit.e<-cfa(model=tofu.model.e, data=Tofu)
summary(tofu.fit.e, standardized=TRUE, fit.measures=TRUE)

#Does not converge
#Private label and club cannot be included with the other variables as they have so little variation.

#Try replacing size with Retail and comparing back to model C

tofu.model.f<-'Seasonal =~major_holiday + other_holidays + season
Product_presentation=~Size +Retail+Promotion + Temporary + New+ Texture+Flavor
Distribution =~Canada + a*SE + a*NE
Texture~~0.0207125*Texture
Flavor~~Temporary
Flavor~~SE
sales~Seasonal+Product_presentation+Distribution'

tofu.fit.f<-cfa(model=tofu.model.f, data=Tofu)
summary(tofu.fit.f, standardized=TRUE, fit.measures=TRUE)

modificationindices(tofu.fit.f, sort = TRUE)

#You can use the above to see the logical recommended correlations to add

anova(tofu.model1,tofu.model2)- #You can use this code to compare any 2 model fits with ANOVA.

#In the model code, #~ shows that a manifest variable is predicting a latent variable. ~~ shows a correlation between variables.

#POSSIBLE ERRORS- "not positive definite"- the wrong classes have been specified. 2 may need to be merged. 1 variable may be a combination of others.

#If you have negative variances in std.all, set the variances manually in the model.
#e.g. other_holidays~~0.165*other_holidays


#The model can either be scaled by setting the variance of the latent variable to 1, and dividing this between the manifest variables
#OR we can set the variance of one of the manifest variables to 1 (more commonly used approach). This is the Lavaan default.

#Interpreting: Different manifest variables have different loadings on the latent variables.
#Std.all in the output shows these loadings. Close to 1 shows a strong relationship to the latent variable.
#0.3 is typically considered an acceptable loading.
#CFI and TLI should be between 0.9 and 1 to show that the model fits the data
#Ours are over 0.7 which show the model is OK but not a great fit.

#VISUALISATION
library(semPlot)


